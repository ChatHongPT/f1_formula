<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>ğŸï¸ F1 Formula</title>
<meta name="color-scheme" content="light dark">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<style>
  :root {
    --ink: #ffffff;
    --muted: #a0a0a0;
    --card: rgba(255,255,255,.08);
    --card-hover: rgba(255,255,255,.12);
    --accent: #ff1801;
    --accent-gold: #ffd700;
    --accent-silver: #c0c0c0;
    --accent-bronze: #cd7f32;
    --gradient-primary: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
    --gradient-accent: linear-gradient(135deg, #ff1801 0%, #ff6b35 100%);
    --shadow: 0 8px 32px rgba(0,0,0,0.3);
    --shadow-hover: 0 12px 48px rgba(0,0,0,0.4);
  }
  
  @media (prefers-color-scheme:dark) {
    :root { --ink: #ffffff; }
  }
  
  * {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
  }
  
  body {
    font-family: 'Inter', system-ui, -apple-system, sans-serif;
    background: var(--gradient-primary);
    color: var(--ink);
    line-height: 1.6;
    overflow-x: hidden;
  }
  
  /* ì• ë‹ˆë©”ì´ì…˜ ë°°ê²½ */
  body::before {
    content: '';
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: 
      radial-gradient(circle at 20% 20%, rgba(255, 24, 1, 0.1) 0%, transparent 50%),
      radial-gradient(circle at 80% 80%, rgba(255, 107, 53, 0.1) 0%, transparent 50%),
      radial-gradient(circle at 40% 60%, rgba(255, 215, 0, 0.05) 0%, transparent 50%);
    z-index: -1;
    animation: backgroundShift 20s ease-in-out infinite;
  }
  
  @keyframes backgroundShift {
    0%, 100% { opacity: 0.3; }
    50% { opacity: 0.6; }
  }
  
  .layout {
    display: grid;
    grid-template-columns: 1.2fr 0.8fr;
    gap: 24px;
    min-height: 100vh;
    padding: 24px;
    max-width: 1400px;
    margin: 0 auto;
  }
  
  .card {
    background: var(--card);
    backdrop-filter: blur(20px);
    border: 1px solid rgba(255,255,255,.12);
    border-radius: 20px;
    padding: 40px;
    box-shadow: var(--shadow);
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
  }
  
  .card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 2px;
    background: var(--gradient-accent);
    opacity: 0;
    transition: opacity 0.3s ease;
  }
  
  .card:hover {
    background: var(--card-hover);
    box-shadow: var(--shadow-hover);
    transform: translateY(-2px);
  }
  
  .card:hover::before {
    opacity: 1;
  }
  
  .title {
    font-weight: 800;
    font-size: 1.5rem;
    margin: 0 0 16px 0;
    background: var(--gradient-accent);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    display: flex;
    align-items: center;
    gap: 12px;
  }
  
  .muted {
    color: var(--muted);
    font-size: 0.875rem;
    font-weight: 400;
  }
  
  .grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 16px;
  }
  
  .podium {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 12px;
    margin-bottom: 20px;
    max-height: 120px;
  }
  
  .podium .p {
    display: flex;
    gap: 10px;
    align-items: center;
    padding: 10px;
    border-radius: 12px;
    background: rgba(255,255,255,.06);
    border: 1px solid rgba(255,255,255,.1);
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
    min-height: 80px;
  }
  
  .podium .p::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 3px;
    background: var(--gradient-accent);
  }
  
  .podium .p:nth-child(1)::before { background: var(--accent-gold); }
  .podium .p:nth-child(2)::before { background: var(--accent-silver); }
  .podium .p:nth-child(3)::before { background: var(--accent-bronze); }
  
  .podium .p:hover {
    background: rgba(255,255,255,.1);
    transform: translateY(-2px);
  }
  
  .podium img {
    width: 50px;
    height: 50px;
    border-radius: 10px;
    object-fit: cover;
    border: 2px solid rgba(255,255,255,.2);
    flex-shrink: 0;
  }
  
  .podium .p > div {
    flex: 1;
    min-width: 0;
  }
  
  .podium .p > div > div:first-child {
    font-size: 0.7rem;
    margin-bottom: 2px;
    font-weight: 600;
  }
  
  .podium .p > div > div:nth-child(2) {
    font-size: 0.75rem;
    font-weight: 600;
    margin-bottom: 2px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  
  .podium .p > div > div:last-child {
    font-size: 0.65rem;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  
  .badge {
    display: inline-block;
    padding: 6px 12px;
    border: 1px solid rgba(255,255,255,.2);
    border-radius: 20px;
    font-weight: 600;
    font-size: 0.75rem;
    background: rgba(255,255,255,.1);
    backdrop-filter: blur(10px);
  }
  
  table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.875rem;
    background: rgba(255,255,255,.02);
    border-radius: 12px;
    overflow: hidden;
  }
  
  .table-container {
    max-height: 400px;
    overflow-y: auto;
    border-radius: 12px;
    background: rgba(255,255,255,.02);
  }
  
  .table-container::-webkit-scrollbar {
    width: 6px;
  }
  
  .table-container::-webkit-scrollbar-track {
    background: rgba(255,255,255,.05);
    border-radius: 3px;
  }
  
  .table-container::-webkit-scrollbar-thumb {
    background: var(--accent);
    border-radius: 3px;
  }
  
  .table-container::-webkit-scrollbar-thumb:hover {
    background: #ff2a15;
  }
  
  th {
    background: rgba(255,255,255,.08);
    padding: 12px 16px;
    text-align: left;
    font-weight: 600;
    color: var(--accent);
    border-bottom: 2px solid rgba(255,255,255,.1);
  }
  
  td {
    padding: 12px 16px;
    border-bottom: 1px solid rgba(255,255,255,.08);
    transition: background 0.2s ease;
  }
  
  tr:hover td {
    background: rgba(255,255,255,.05);
  }
  
  select {
    padding: 8px 12px;
    border-radius: 10px;
    background: rgba(255,255,255,.1);
    border: 1px solid rgba(255,255,255,.2);
    color: inherit;
    font-weight: 500;
    backdrop-filter: blur(10px);
  }
  
  .legend {
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
    margin: 16px 0;
  }
  
  .legend .dot {
    width: 14px;
    height: 14px;
    border-radius: 50%;
    box-shadow: 0 0 8px rgba(255,255,255,.3);
  }
  
  .sim-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 16px;
  }
  
  .pill {
    display: inline-flex;
    gap: 8px;
    align-items: center;
    border: 1px solid rgba(255,255,255,.2);
    border-radius: 20px;
    padding: 8px 16px;
    background: rgba(255,255,255,.1);
    backdrop-filter: blur(10px);
    font-weight: 500;
  }
  
  /* ë°˜ì‘í˜• ë””ìì¸ */
  @media (max-width: 1024px) {
    .layout {
      grid-template-columns: 1fr;
      gap: 16px;
      padding: 16px;
    }
    
    .podium {
      grid-template-columns: 1fr;
    }
  }
  
  /* ë¡œë”© ì• ë‹ˆë©”ì´ì…˜ */
  .loading {
    display: inline-block;
    width: 20px;
    height: 20px;
    border: 2px solid rgba(255,255,255,.3);
    border-radius: 50%;
    border-top-color: var(--accent);
    animation: spin 1s ease-in-out infinite;
  }
  
  @keyframes spin {
    to { transform: rotate(360deg); }
  }
  
  /* íƒ­ ìŠ¤íƒ€ì¼ */
  .tab-container {
    width: 100%;
  }
  
  .tab-buttons {
    display: flex;
    gap: 4px;
    margin-bottom: 20px;
    background: rgba(255,255,255,.05);
    border-radius: 12px;
    padding: 4px;
  }
  
  .tab-button {
    flex: 1;
    padding: 12px 16px;
    border: none;
    border-radius: 8px;
    background: transparent;
    color: var(--muted);
    font-weight: 600;
    font-size: 0.79rem;
    cursor: pointer;
    transition: all 0.3s ease;
    position: relative;
  }
  
  .tab-button:hover {
    background: rgba(255,255,255,.1);
    color: var(--ink);
  }
  
  .tab-button.active {
    background: var(--gradient-accent);
    color: white;
    box-shadow: 0 4px 12px rgba(255, 24, 1, 0.3);
  }
  
  .tab-content {
    position: relative;
  }
  
  .tab-panel {
    display: none;
    animation: fadeIn 0.3s ease;
  }
  
  .tab-panel.active {
    display: block;
  }
  
  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }
</style>
</head>
<body>
<div class="layout">
  <!-- Left: Simulation -->
  <section class="card">
    <div class="sim-header">
      <h2 class="title">
        <img src="/F1-Logo.png" alt="F1 Logo" style="height: 40px; margin-right: 12px;">
        F1 formula 1
      </h2>
      <div class="pill">
        <span class="loading"></span>
        <span id="sessionLabel" class="muted">Loading session...</span>
      </div>
    </div>
    <!-- SVG Track: ì˜¤ë²Œ + ì½”ë„ˆ 2ê°œ ëŠë‚Œ -->
    <svg id="track" viewBox="0 0 800 500" width="100%" height="460" style="background:radial-gradient(900px 380px at -10% -10%, #1c1c20, transparent 60%), radial-gradient(700px 380px at 110% 110%, #141418, transparent 60%)">
      <!-- Track path -->
      <defs>
        <filter id="shadow" x="-50%" y="-50%" width="200%" height="200%">
          <feDropShadow dx="0" dy="2" stdDeviation="3" flood-color="#000" flood-opacity="0.6"/>
        </filter>
      </defs>
      <path id="circuit" d="M 150 250
                            C 150 120, 300 80, 400 80
                            C 500 80, 650 120, 650 250
                            C 650 380, 500 420, 400 420
                            C 300 420, 150 380, 150 250 Z"
            fill="none" stroke="#555" stroke-width="16" filter="url(#shadow)" />
      <!-- Cars will be appended here -->
      <g id="cars"></g>
    </svg>
    <div class="legend" id="legend"></div>
  </section>

  <!-- Right: Dashboard -->
  <section class="card">
    <h2 class="title">ğŸ Race Dashboard</h2>
    <div class="podium" id="podium"></div>

    <div class="card">
      <div class="tab-container">
        <div class="tab-buttons">
          <button class="tab-button active" data-tab="teams">ğŸ† íŒ€ ìˆœìœ„</button>
          <button class="tab-button" data-tab="pits">âš¡ í”¼íŠ¸ ìŠ¤íƒ‘</button>
          <button class="tab-button" data-tab="laps">â±ï¸ ë© ê¸°ë¡</button>
        </div>
        <div class="tab-content">
          <div id="teams-tab" class="tab-panel active">
            <div class="table-container">
              <table id="teamTable"><thead><tr><th>Rank</th><th>Team</th><th>Points</th></tr></thead><tbody></tbody></table>
            </div>
          </div>
          <div id="pits-tab" class="tab-panel">
            <div class="table-container">
              <table id="pitTable"><thead><tr><th>Lap</th><th>#</th><th>Driver</th><th>Duration(s)</th></tr></thead><tbody></tbody></table>
            </div>
          </div>
          <div id="laps-tab" class="tab-panel">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
              <h4 style="margin:0;font-weight:600">Driver Selection</h4>
              <select id="driverSelect"></select>
            </div>
            <div class="table-container">
              <table id="lapTable"><thead><tr><th>Lap</th><th>Time(s)</th></tr></thead><tbody></tbody></table>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>
</div>

<!-- ë°°ê²½ìŒì•… -->
<audio id="bgMusic" loop autoplay>
  <source src="/f1.mp3" type="audio/mpeg">
  Your browser does not support the audio element.
</audio>

<script>
(async function(){
  // 1) ë°ì´í„° ë¡œë“œ(ë™ì¼ ë„ë©”ì¸ì˜ ì •ì  íŒŒì¼)
  const base = '/f1_data';
  const [meta, drivers, results, pits, laps, teamStandings, podium] = await Promise.all([
    fetch(`${base}/meta.json`).then(r=>r.json()).catch(()=>({})),
    fetch(`${base}/drivers.json`).then(r=>r.json()).catch(()=>[]),
    fetch(`${base}/results.json`).then(r=>r.json()).catch(()=>[]),
    fetch(`${base}/pits.json`).then(r=>r.json()).catch(()=>[]),
    fetch(`${base}/laps.json`).then(r=>r.json()).catch(()=>[]),
    fetch(`${base}/team_standings.json`).then(r=>r.json()).catch(()=>[]),
    fetch(`${base}/podium.json`).then(r=>r.json()).catch(()=>[]),
  ]);

  // í—¤ë” ë¼ë²¨
  const label = [meta.location, meta.session_name, meta.date_start].filter(Boolean).join(' Â· ');
  const sessionLabel = document.getElementById('sessionLabel');
  const loadingSpinner = sessionLabel.previousElementSibling;
  
  // ë¡œë”© ì™„ë£Œ í›„ ìŠ¤í”¼ë„ˆ ì œê±°
  if (loadingSpinner && loadingSpinner.classList.contains('loading')) {
    loadingSpinner.remove();
  }
  
  sessionLabel.textContent = label || 'Latest Session';

  // ë°°ê²½ìŒì•… ì œì–´
  const bgMusic = document.getElementById('bgMusic');
  let isMusicPlaying = false;
  
  // ì‚¬ìš©ì ìƒí˜¸ì‘ìš© í›„ ìŒì•… ì¬ìƒ (ë¸Œë¼ìš°ì € ì •ì±…)
  document.addEventListener('click', () => {
    if (!isMusicPlaying) {
      bgMusic.play().then(() => {
        isMusicPlaying = true;
        console.log('ğŸµ F1 ë°°ê²½ìŒì•…ì´ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤!');
      }).catch(err => {
        console.log('ìŒì•… ì¬ìƒ ì‹¤íŒ¨:', err);
      });
    }
  });

  // íƒ­ ê¸°ëŠ¥
  const tabButtons = document.querySelectorAll('.tab-button');
  const tabPanels = document.querySelectorAll('.tab-panel');
  
  tabButtons.forEach(button => {
    button.addEventListener('click', () => {
      const targetTab = button.getAttribute('data-tab');
      
      // ëª¨ë“  ë²„íŠ¼ê³¼ íŒ¨ë„ì—ì„œ active í´ë˜ìŠ¤ ì œê±°
      tabButtons.forEach(btn => btn.classList.remove('active'));
      tabPanels.forEach(panel => panel.classList.remove('active'));
      
      // í´ë¦­ëœ ë²„íŠ¼ê³¼ í•´ë‹¹ íŒ¨ë„ì— active í´ë˜ìŠ¤ ì¶”ê°€
      button.classList.add('active');
      document.getElementById(`${targetTab}-tab`).classList.add('active');
    });
  });

  // small helpers
  const dmap = new Map(drivers.map(d => [String(d.driver_number), d]));
  const by = (key) => (a,b) => (a[key]??0) - (b[key]??0);
  const byDesc = (key) => (a,b) => (b[key]??0) - (a[key]??0);

  // 2) í¬ë””ì›€ ì¹´ë“œ
  const pod = document.getElementById('podium');
  (podium || []).sort(by('position')).forEach(p=>{
    const d = dmap.get(String(p.driver_number)) || {};
    const head = (p.headshot_url || d.headshot_url) || 'https://via.placeholder.com/120x120.png?text=No+Photo';
    const color = '#'+(d.team_colour || p.team_colour || '777777');
    const driverName = p.full_name || d.full_name || d.broadcast_name || `Driver #${p.driver_number}`;
    const teamName = p.team_name || d.team_name || 'Unknown Team';
    pod.insertAdjacentHTML('beforeend', `
      <div class="p" style="border-left:4px solid ${color}">
        <img src="${head}" alt="${driverName}">
        <div>
          <div><strong>${p.position}ìœ„</strong> Â· <span class="badge">#${p.driver_number}</span></div>
          <div>${driverName}</div>
          <div class="muted">${teamName}</div>
        </div>
      </div>
    `);
  });

  // 3) íŒ€ ìˆœìœ„ í…Œì´ë¸”
  const teamTbody = document.querySelector('#teamTable tbody');
  (teamStandings || []).forEach((t, i)=>{
    teamTbody.insertAdjacentHTML('beforeend', `<tr><td>${i+1}</td><td>${t.team_name}</td><td>${t.points}</td></tr>`);
  });

  // 4) í”¼íŠ¸ìŠ¤í†±(ìµœì‹ ìˆœ ìƒìœ„ 12ê°œ í‘œì‹œ)
  const pitTbody = document.querySelector('#pitTable tbody');
  pits.sort(byDesc('lap_number')).slice(0, 12).forEach(p=>{
    const dn = String(p.driver_number);
    const name = (dmap.get(dn)?.full_name) || `Driver ${dn}`;
    pitTbody.insertAdjacentHTML('beforeend', `<tr>
      <td>${p.lap_number ?? ''}</td>
      <td>#${dn}</td>
      <td>${name}</td>
      <td>${p.pit_duration ?? ''}</td>
    </tr>`);
  });

  // 5) ë“œë¼ì´ë²„ ì„ íƒ + ë©íƒ€ì„ í…Œì´ë¸”
  const driverSelect = document.getElementById('driverSelect');
  drivers.forEach(d=>{
    const opt = document.createElement('option');
    opt.value = d.driver_number;
    const displayName = d.full_name || d.broadcast_name || `Driver #${d.driver_number}`;
    opt.textContent = `${displayName} (#${d.driver_number})`;
    driverSelect.appendChild(opt);
  });
  function renderLaps(dn){
    const body = document.querySelector('#lapTable tbody');
    body.innerHTML = '';
    const rows = laps.filter(l=>String(l.driver_number)===String(dn))
                     .sort(by('lap_number'))
                     .slice(0, 25); // ë„ˆë¬´ ê¸¸ë©´ ìƒìœ„ 25ë©ë§Œ
    rows.forEach(r=>{
      let sec = r.lap_duration;
      // lap_durationì´ s ë‹¨ìœ„ í˜¹ì€ ISOì¼ ìˆ˜ ìˆìŒ â†’ ìˆ«ìë§Œ ë³´ì´ë©´ ê·¸ëŒ€ë¡œ í‘œì‹œ
      body.insertAdjacentHTML('beforeend', `<tr><td>${r.lap_number}</td><td>${sec ?? ''}</td></tr>`);
    });
  }
  if (drivers[0]) renderLaps(drivers[0].driver_number);
  driverSelect.addEventListener('change', e=>renderLaps(e.target.value));

  // 6) ì‹œë®¬ë ˆì´ì…˜(ì• ë‹ˆë©”ì´ì…˜)
  // ë“œë¼ì´ë²„ ì¤‘ 8ëª… ëœë¤ ì„ ë°œ â†’ íŒ€ ì»¬ëŸ¬ ì ìœ¼ë¡œ íŠ¸ë™ ë”°ë¼ íšŒì „
  const pickN = (arr, n) => arr.sort(()=>Math.random()-0.5).slice(0, n);
  const roster = pickN(drivers, Math.min(8, drivers.length));
  const teams = [];
  const carsG = document.getElementById('cars');
  const legend = document.getElementById('legend');
  const path = document.getElementById('circuit');
  const pathLen = path.getTotalLength();

  roster.forEach((d, i)=>{
    const color = '#'+(d.team_colour || '999999');
    // circle element
    const c = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
    c.setAttribute('r', 7);
    c.setAttribute('fill', color);
    c.setAttribute('stroke', '#000');
    c.setAttribute('stroke-width', '1.5');
    c.dataset.offset = String(Math.random() * pathLen);
    // ê¸°ë³¸ ì†ë„: 90~130 px/s ë²”ìœ„
    c.dataset.speed = String(90 + Math.random()*40);
    c.dataset.boost = '0';
    c.dataset.num = d.driver_number;
    carsG.appendChild(c);

    const displayName = d.full_name || d.broadcast_name || `Driver #${d.driver_number}`;
    legend.insertAdjacentHTML('beforeend', `
      <span class="pill"><span class="dot" style="background:${color}"></span>
      #${d.driver_number} Â· ${displayName}</span>`);
    teams.push({el:c, color, d});
  });

  // ê°„ë‹¨í•œ ë¶€ìŠ¤íŠ¸(ë¬´ì‘ìœ„ ê°€ì† ì´ë²¤íŠ¸)ë¡œ ì¶”ì›” ëŠë‚Œ
  function tick(ts){
    if (!tick.last) tick.last = ts;
    const dt = (ts - tick.last) / 1000; // seconds
    tick.last = ts;

    teams.forEach(t=>{
      let s = +t.el.dataset.speed;
      let boost = +t.el.dataset.boost;
      if (Math.random() < 0.01) { // 1% í™•ë¥ ë¡œ 1~2ì´ˆê°„ boost
        boost = 1 + Math.random()*1;
        t.el.dataset.boost = boost.toFixed(3);
        setTimeout(()=>{ t.el.dataset.boost = '0'; }, 1000 + Math.random()*1000);
      }
      const v = s * (1 + boost*0.35); // ë¶€ìŠ¤íŠ¸ ì˜í–¥
      let off = (+t.el.dataset.offset + v*dt) % pathLen;
      t.el.dataset.offset = String(off);
      const p = path.getPointAtLength(off);
      t.el.setAttribute('cx', p.x);
      t.el.setAttribute('cy', p.y);
    });

    requestAnimationFrame(tick);
  }
  requestAnimationFrame(tick);

})();
</script>
</body>
</html>
